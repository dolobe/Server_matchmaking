<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe</title>
    <link rel="stylesheet" href="./static/styles.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <h1>Tic Tac Toe</h1>
    <div class="status" id="status">Waiting for opponent...</div>
    <div class="board" id="board"></div>
    <div class="messages" id="messages"></div>

    <script>
        const socket = io();
        const board = document.getElementById('board');
        const status = document.getElementById('status');
        let matchId = null;
        let player = null;
        let currentTurn = null; // Variable pour suivre le joueur dont c'est le tour

        function initializeBoard() {
            board.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                cell.addEventListener('click', () => makeMove(i));
                board.appendChild(cell);
            }
        }

        function makeMove(index) {
            const cell = document.querySelector(`.cell[data-index="${index}"]`);
            if (!cell.classList.contains('taken') && player === currentTurn) {
                // Afficher le symbole localement
                cell.textContent = player === 'player1' ? 'X' : 'O';
                cell.classList.add('taken');

                // Envoyer le mouvement au serveur
                socket.emit('play_turn', {
                    match_id: matchId,
                    player: player,
                    move: index
                });

                // Bloquer les clics jusqu'à ce que le serveur confirme
                currentTurn = null;
                document.getElementById('messages').textContent = "Waiting for your opponent...";
            }
        }

        function updateBoard(boardState) {
            const cells = document.querySelectorAll('.cell');
            boardState.forEach((value, index) => {
                const cell = cells[index];
                cell.textContent = value === '-' ? '' : value; // Affiche "X" ou "O"
                if (value !== '-') {
                    cell.classList.add('taken'); // Marque la case comme occupée
                }
            });
        }

        socket.on('server_message', (data) => {
            if (data.action === 'match_created') {
                matchId = data.match_id;
                player = data.player;
                currentTurn = 'player1'; // Le joueur 1 commence toujours
                status.textContent = `Match started! You are ${player === 'player1' ? 'X' : 'O'}`;
                document.getElementById('messages').textContent = currentTurn === player
                    ? "It's your turn!"
                    : "Waiting for your opponent...";
                initializeBoard();
            } else if (data.action === 'update_board') {
                updateBoard(data.board_state);
                currentTurn = data.current_player; // Mettre à jour le joueur dont c'est le tour
                document.getElementById('messages').textContent = currentTurn === player
                    ? "It's your turn!"
                    : "Waiting for your opponent...";
            } else if (data.action === 'game_over') {
                status.textContent = `Game over! Winner: ${data.winner}`;
                document.getElementById('messages').textContent = data.winner === player
                    ? "Congratulations, you won!"
                    : "You lost. Better luck next time!";
                currentTurn = null; // Bloquer les clics après la fin du jeu
            }
        });
        initializeBoard();
    </script>
</body>
</html>